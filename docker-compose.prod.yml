# Docker Compose para testing local del contenedor de producci칩n
# Uso: docker-compose -f docker-compose.prod.yml up
# Esto prueba el mismo contenedor que se desplegar치 en Cloud Run
#
# NOTA: Docker Compose lee autom치ticamente archivos .env en el directorio actual
# Si quieres usar .env.local, puedes:
# 1. Copiar .env.local a .env antes de ejecutar
# 2. O usar: env_file: .env.local (ver abajo)

version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
      # Build args (opcionales, pueden venir de .env o .env.local)
      args:
        - APP_ENV=production
    container_name: emi-app-prod
    ports:
      - "3000:3000"
    # Opci칩n 1: Leer desde .env.local (recomendado)
    env_file:
      - .env.local
      - .env # Fallback a .env si .env.local no existe
    environment:
      - NODE_ENV=production
      - APP_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      # Variables de Firebase (usar valores reales o desde .env)
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
      # Database (usar valores reales)
      - DATABASE_URL=${DATABASE_URL}
      # Firebase Admin (opcional para testing local)
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
      - FIREBASE_ADMIN_CREDENTIALS=${FIREBASE_ADMIN_CREDENTIALS}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - emi-network

networks:
  emi-network:
    driver: bridge
