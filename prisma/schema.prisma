// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
}

enum KitCategory {
  development
  research
  design
  tokens
}

enum Role {
  ux_ui_designer
  product_designer
  product_design_lead
  admin
  super_admin
}

enum ClientPlan {
  free
  pro
  enterprise
}

enum KitItemScope {
  workspace
  client
}

model Kit {
  id          String      @id @default(uuid())
  title       String
  description String
  icon        String // nombre del icono de Lucide
  category    KitCategory
  downloadUrl String?
  docsUrl     String?
  tags        String[]    @default([])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String? // para futuro multi-tenant
  isActive    Boolean     @default(true) // para soft deletes

  // Relaciones
  files KitFile[]
  links KitLink[]

  @@index([category])
  @@index([isActive])
  @@index([createdAt])
  @@map("kits")
}

model KitFile {
  id          String       @id @default(uuid())
  kitId       String
  title       String // Título personalizado del archivo
  name        String // Nombre original del archivo
  fileUrl     String // URL de Firebase Storage
  fileSize    Int? // tamaño en bytes
  mimeType    String?
  scope       KitItemScope @default(workspace) // Alcance de visibilidad
  uploadedBy  String // Email del usuario que subió el archivo
  workspaceId String? // ID del workspace donde se subió
  clientId    String? // ID del cliente donde se subió
  uploadedAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relaciones
  kit Kit @relation(fields: [kitId], references: [id], onDelete: Cascade)

  @@index([kitId])
  @@index([uploadedAt])
  @@index([workspaceId])
  @@index([clientId])
  @@index([scope])
  @@map("kit_files")
}

model KitLink {
  id          String       @id @default(uuid())
  kitId       String
  title       String
  url         String
  description String?
  scope       KitItemScope @default(workspace) // Alcance de visibilidad
  createdBy   String // Email del usuario que creó el enlace
  workspaceId String? // ID del workspace donde se creó
  clientId    String? // ID del cliente donde se creó
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relaciones
  kit Kit @relation(fields: [kitId], references: [id], onDelete: Cascade)

  @@index([kitId])
  @@index([createdAt])
  @@index([workspaceId])
  @@index([clientId])
  @@index([scope])
  @@map("kit_links")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  displayName   String?
  photoUrl      String?
  role          Role      @default(ux_ui_designer)
  preferences   Json? // UserPreferences como JSON
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  clientAccesses    UserClientAccess[]
  workspaceAccesses UserWorkspaceAccess[]
  sessionConfig     UserSessionConfig?

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Client {
  id        String     @id @default(uuid())
  name      String
  slug      String     @unique
  logoUrl   String?
  plan      ClientPlan @default(free)
  settings  Json? // ClientSettings como JSON
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relaciones
  workspaces     Workspace[]
  userAccesses   UserClientAccess[]
  sessionConfigs UserSessionConfig[] @relation("ClientSessionConfig")

  @@index([slug])
  @@index([createdAt])
  @@map("clients")
}

model Workspace {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  slug        String
  description String?
  settings    Json? // WorkspaceSettings como JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  client         Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userAccesses   UserWorkspaceAccess[]
  sessionConfigs UserSessionConfig[]   @relation("WorkspaceSessionConfig")

  @@unique([clientId, slug])
  @@index([clientId])
  @@index([slug])
  @@index([createdAt])
  @@map("workspaces")
}

model UserClientAccess {
  id        String   @id @default(uuid())
  userId    String
  clientId  String
  role      Role? // Rol específico en este cliente
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
  @@map("user_client_access")
}

model UserWorkspaceAccess {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String
  role        Role? // Rol específico en este workspace
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("user_workspace_access")
}

model UserSessionConfig {
  id                 String   @id @default(uuid())
  userId             String   @unique
  defaultClientId    String?
  defaultWorkspaceId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relaciones
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  defaultClient    Client?    @relation("ClientSessionConfig", fields: [defaultClientId], references: [id], onDelete: SetNull)
  defaultWorkspace Workspace? @relation("WorkspaceSessionConfig", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("user_session_config")
}
